# MemoriaMCP

<!-- Rule 4 (User): Platform Declaration -->
**Target Development Environment: macOS**

MCP server for managing memories with a PostgreSQL backend, built with
FastMCP.

## Project Overview

MemoriaMCP provides tools to add and query textual memories. It uses
`asyncpg` for asynchronous PostgreSQL interaction and can leverage
PostgreSQL's full-text search capabilities or `pgvector` for
semantic similarity searches (if embeddings are configured).

This project adheres to specific coding standards and practices outlined
in the `user_rules.md` and `project_rules.md`.

## Features

- Add new memories (textual content).
- Query memories using full-text search.
- (Optional) Support for vector embeddings and similarity search via `pgvector`.
- MCP-compliant API via FastMCP.

## Project Structure

```
mcp_server_pg/
├── src/
│   ├── main.py            # FastMCP entrypoint
│   ├── db/
│   │   ├── pool.py        # asyncpg pool init
│   │   └── schema.sql     # DDL (memories table, pgvector)
│   ├── memory/
│   │   ├── manager.py     # insert & query logic
│   │   └── schemas.py     # Pydantic models
│   └── embeddings.py      # (opt) embed via OpenAI (To be created)
├── tests/
│   ├── conftest.py        # Pytest shared fixtures
│   ├── test_manager.py    # Unit tests (mock asyncpg)
│   └── test_main.py       # Integration tests (pytest-postgresql)
├── .flake8               # Flake8 configuration
├── .python-version       # Specifies Python 3.12.10 (if using pyenv)
├── Dockerfile            # Builds the MCP server image
├── docker-compose.yml    # Orchestrates server & Postgres
├── pyproject.toml        # Metadata & dependencies (uv, black, mypy)
├── uv.lock               # Locked dependencies (generated by uv)
└── README.md             # This file
```

## Setup and Installation

### Prerequisites

- Python 3.12.10 (Rule 1 Project)
- `uv` (v0.6.x or compatible) for environment and package management (Rule 5 Project)
- Docker and Docker Compose (for containerized deployment)
- PostgreSQL server (if not using Docker setup)

### Environment Setup with `uv`

1.  **Install `uv`**:
    Follow instructions at [astral.sh/uv](https://astral.sh/uv).

2.  **Create and activate a virtual environment**:
    ```bash
    uv venv
    source .venv/bin/activate
    ```

3.  **Install dependencies**:
    ```bash
    uv sync --all-extras # Install main and dev dependencies
    # or `uv pip install -r requirements.txt` if you generate one
    ```

### Database Setup

1.  Ensure you have a PostgreSQL instance running.
2.  Create a database (e.g., `memoria_db`).
3.  Set the following environment variables (or use a `.env` file, but
    ensure it's in `.gitignore`):
    ```bash
    export DB_USER="your_db_user"
    export DB_PASSWORD="your_db_password"
    export DB_HOST="localhost" # or your DB host
    export DB_PORT="5432"    # or your DB port
    export DB_NAME="memoria_db"
    ```
4.  Apply the schema:
    You'll need a way to apply `src/db/schema.sql`. This can be done
    using `psql` or a migration tool (not currently in scope).
    Example with `psql`:
    ```bash
    psql -U $DB_USER -h $DB_HOST -p $DB_PORT -d $DB_NAME -f src/db/schema.sql
    ```

## Running the Application

```bash
python src/main.py
```

The server will start, typically on `http://0.0.0.0:8000`.

## Running Tests

Ensure development dependencies are installed (`uv sync --all-extras`).

```bash
pytest
```

To include coverage (Rule 4 Testing):
```bash
pytest --cov=src --cov-report=html
```

## Linting and Formatting

-   **Black (Formatter)**: (Rule 6 User, Rule 3 Code Style)
    ```bash
    black .
    ```
-   **Flake8 (Linter)**: (Rule 6 User, Rule 3 Code Style)
    ```bash
    flake8 .
    ```
-   **Mypy (Type Checker)**: (Rule 10 User, Rule 3 Code Style)
    ```bash
    mypy src tests
    ```

Pre-commit hooks should be configured to run these automatically (Rule 10 User).

## Docker Deployment

(Details to be added once `Dockerfile` and `docker-compose.yml` are complete)

1.  Build the Docker image:
    ```bash
    docker-compose build
    ```
2.  Run the application and PostgreSQL using Docker Compose:
    ```bash
    docker-compose up
    ```

## API Endpoints

(Provided by FastMCP based on `src/main.py` tools and resources)

-   **Tool: `add_memory`**
    -   Adds a new memory.
    -   Parameters: `text: str`
    -   Returns: `{"id": <uuid>}`
-   **Resource: `list_memory`**
    -   Queries memories.
    -   Parameters: `query: str`, `top_k: int = 5`
    -   Returns: List of memory objects.

Refer to FastMCP documentation for how to interact with these endpoints.

## Security Notes

-   **Read-Only Database User for AI**: (Rule 1 Security) The application, when
    interacting via AI-generated code paths, should use a database user with
    `SELECT` privileges only.
-   **Credential Management**: (Rule 3 Security) Database credentials must be
    loaded from environment variables and not hard-coded.

## Contributing

(Details on contributing, commit message format (Rule 9 User), etc.)

## License

This project is licensed under the MIT License. See `pyproject.toml`.